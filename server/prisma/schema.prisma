// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =================================================================================================
// CORE & AUTH
// =================================================================================================

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  fullName  String?
  name      String?  
  
  hashedRefreshToken String?
  mfaSecret          String?          @map("mfa_secret")
  isMfaEnabled       Boolean          @default(false) @map("is_mfa_enabled")

  tenantId  String?
  tenant    Tenant?  @relation(fields: [tenantId], references: [id])
  
  branchId  String?
  branch    Branch?  @relation(fields: [branchId], references: [id]) 
  
  roleId    String?
  role      Role?    @relation(fields: [roleId], references: [id])     

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  notificationDeliveries NotificationDelivery[]
  curatorAssignments     CuratorAssignment[]
  auditLogs              AuditLog[] 
  files                  File[]     

  @@map("users")
}

model Tenant {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique
  
  email       String?
  phone       String?
  website     String?
  
  status      String   @default("PENDING") 
  address     Json?    

  users       User[]
  branches    Branch[]
  roles       Role[]
  
  currentSubscription Subscription?
  usageLogs           UsageLog[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("tenants")
}

model Branch {
  id        String   @id @default(uuid())
  name      String
  
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  users     User[]
  auditLogs AuditLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("branches")
}

// =================================================================================================
// RBAC (Roles & Permissions)
// =================================================================================================

model Role {
  id          String   @id @default(uuid())
  name        String
  description String?
  isSystem    Boolean  @default(false)

  tenantId    String?
  tenant      Tenant?  @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  users       User[]
  permissions RolePermission[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt

  @@unique([tenantId, name])
  @@map("roles")
}

model Permission {
  id          String   @id @default(uuid())
  name        String?   
  slug        String   @unique 
  description String?
  module      String   

  roles       RolePermission[]
  menuItems   MenuItem[]

  @@map("permissions")
}

model RolePermission {
  roleId       String
  permissionId String

  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@map("role_permissions")
}

// =================================================================================================
// ACCESS CONTROL (ABAC) & AUDIT
// =================================================================================================

model AccessPolicy {
  id          String   @id @default(uuid())
  name        String
  resource    String
  action      String
  conditions  Json?
  
  userId           String?
  allowedDays      String? 
  allowedStartHour Int?
  allowedEndHour   Int?
  allowedIps       String?

  effect      String   @default("ALLOW")

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("access_policies")
}

model AuditLog {
  id        String   @id @default(uuid())
  action    String
  resource  String?
  module    String?
  
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])
  
  branchId  String?
  branch    Branch?  @relation(fields: [branchId], references: [id])

  tenantId  String?
  details   Json?
  
  ipAddress String?
  userAgent String?
  
  createdAt DateTime @default(now())

  @@map("audit_logs")
}

model SecurityLog {
  id        String   @id @default(uuid())
  action    String   
  
  userId    String?
  ipAddress String?
  userAgent String?
  device    String? // ADDED
  location  String? // ADDED
  details   Json?

  createdAt DateTime @default(now())

  @@map("security_logs")
}

// =================================================================================================
// ADDRESSES
// =================================================================================================

model Country {
  id        String   @id @default(uuid())
  name      String
  code      String   @unique
  phoneCode String

  cities    City[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  @@map("countries")
}

model City {
  id        String   @id @default(uuid())
  name      String
  countryId String
  country   Country  @relation(fields: [countryId], references: [id], onDelete: Cascade)
  districts District[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  @@map("cities")
}

model District {
  id        String   @id @default(uuid())
  name      String
  cityId    String
  city      City     @relation(fields: [cityId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  @@map("districts")
}

// =================================================================================================
// BILLING & SUBSCRIPTION
// =================================================================================================

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  SUSPENDED
  TRIALING
}

enum BillingCycle {
  MONTHLY
  YEARLY
}

enum InvoiceStatus {
  DRAFT
  OPEN
  PAID
  VOID
  UNCOLLECTIBLE
}

enum TransactionStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
}

model Package {
  id            String   @id @default(cuid())
  name          String
  description   String?
  priceMonthly  Decimal  @db.Decimal(10, 2)
  priceYearly   Decimal  @db.Decimal(10, 2)
  currency      String   @default("AZN")
  
  maxUsers      Int      @default(5) 
  maxStorageGB  Int      @default(10)
  maxBranches   Int      @default(1)
  
  features      String?  

  isActive      Boolean  @default(true)
  isPopular     Boolean  @default(false)

  subscriptions Subscription[]
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("packages")
}

model Subscription {
  id              String             @id @default(cuid())
  tenantId        String             @unique
  tenant          Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  packageId       String
  package         Package            @relation(fields: [packageId], references: [id])
  
  status          SubscriptionStatus @default(ACTIVE)
  billingCycle    BillingCycle       @default(MONTHLY)
  
  startDate       DateTime           @default(now())
  nextBillingDate DateTime
  endDate         DateTime?          
  trialEndsAt     DateTime?

  items           SubscriptionItem[]
  invoices        Invoice[]
  paymentMethods  PaymentMethod[]
  
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  @@map("subscriptions")
}

model SubscriptionItem {
  id             String       @id @default(cuid())
  subscriptionId String
  subscription   Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  
  name           String
  type           String       
  quantity       Int          @default(1)
  unitPrice      Decimal      @db.Decimal(10, 2)
  
  addedAt        DateTime     @default(now())

  @@map("subscription_items")
}

model Invoice {
  id             String        @id @default(cuid())
  subscriptionId String
  subscription   Subscription  @relation(fields: [subscriptionId], references: [id])
  
  number         String        @unique 
  status         InvoiceStatus @default(DRAFT)
  
  amountDue      Decimal       @db.Decimal(10, 2)
  amountPaid     Decimal       @db.Decimal(10, 2) @default(0)
  amountRemaining Decimal      @db.Decimal(10, 2)
  currency       String        @default("AZN")
  
  dueDate        DateTime
  paidAt         DateTime?
  
  pdfUrl         String?
  
  items          Json?         
  transactions   Transaction[]

  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@map("invoices")
}

model PaymentMethod {
  id             String       @id @default(cuid())
  subscriptionId String
  subscription   Subscription @relation(fields: [subscriptionId], references: [id])
  
  type           String       
  provider       String       
  token          String?      
  last4          String?
  expiryMonth    Int?
  expiryYear     Int?
  
  isDefault      Boolean      @default(false)
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@map("payment_methods")
}

model Transaction {
  id             String            @id @default(cuid())
  invoiceId      String
  invoice        Invoice           @relation(fields: [invoiceId], references: [id])
  
  amount         Decimal           @db.Decimal(10, 2)
  currency       String            @default("AZN")
  status         TransactionStatus
  
  providerTxId   String?           
  failureReason  String?
  
  processedAt    DateTime          @default(now())

  @@map("transactions")
}

model UsageLog {
  id        String   @id @default(cuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  metric    String   
  value     Float
  timestamp DateTime @default(now())
  
  @@map("usage_logs")
}

// =================================================================================================
// UTILS & MENU
// =================================================================================================

model File {
  id           String   @id @default(uuid())
  originalName String
  filename     String
  mimeType     String
  size         Int
  path         String
  bucket       String?
  
  publicUrl    String?
  uploadedBy   String? 
  user         User?   @relation(fields: [uploadedBy], references: [id]) 
  
  usage        String? // e.g. "AVATAR"
  module       String? // ADDED: e.g. "GENERAL", "INVOICE"

  createdAt    DateTime @default(now())
  @@map("files")
}

model Menu {
  id        String  @id @default(uuid())
  name      String
  slug      String? @unique
  
  items     MenuItem[]

  isActive  Boolean @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@map("menus")
}

model MenuItem {
  id          String  @id @default(uuid())
  title       String
  icon        String?
  path        String?
  order       Int     @default(0)
  
  menuId      String
  menu        Menu    @relation(fields: [menuId], references: [id], onDelete: Cascade)

  parentId    String?
  parent      MenuItem?  @relation("MenuHierarchy", fields: [parentId], references: [id])
  children    MenuItem[] @relation("MenuHierarchy")

  permissionId String?
  permission   Permission? @relation(fields: [permissionId], references: [id])

  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt

  @@map("menu_items")
}

model Notification {
  id        String   @id @default(uuid())
  subject   String
  body      String
  priority  String
  type      String
  senderId  String?
  targetFilter String? 
  createdAt DateTime @default(now())
  deliveries NotificationDelivery[]
  @@map("notifications")
}

model NotificationDelivery {
  id             String   @id @default(uuid())
  notificationId String
  userId         String
  status         String
  readAt         DateTime?
  sentAt         DateTime @default(now())
  notification   Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@map("notification_deliveries")
}

model CuratorAssignment {
  id             String   @id @default(uuid())
  userId         String
  targetTenantId String?
  targetBranchId String?
  canView        Boolean @default(true)
  canEdit        Boolean @default(false)
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@map("curator_assignments")
}
