// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =================================================================================================
// CORE & AUTH
// =================================================================================================

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  fullName  String?
  name      String?  
  isOwner   Boolean  @default(false)
  scope     String   @default("TENANT") // SYSTEM or TENANT
  
  hashedRefreshToken String?
  mfaSecret          String?          @map("mfa_secret")
  isMfaEnabled       Boolean          @default(false) @map("is_mfa_enabled")

  tenantId  String?
  tenant    Tenant?  @relation(fields: [tenantId], references: [id])
  
  branchId  String?
  branch    Branch?  @relation(fields: [branchId], references: [id]) 
  


  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  notificationDeliveries NotificationDelivery[]
  curatorAssignments     CuratorAssignment[]
  auditLogs              AuditLog[] 
  files                  File[]     
  roles                  UserRole[] // Multi-Role Support
  refreshTokens          RefreshToken[] // Added for Bank-Grade Rotation

  @@map("users")
}

model RefreshToken {
  id            String    @id @default(uuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  familyId      String    // UUID for rotation family
  tokenHash     String    @unique
  issuedAt      DateTime  @default(now())
  expiresAt     DateTime
  revokedAt     DateTime?
  revokedReason String?
  createdByIp   String?
  userAgent     String?
  
  @@index([userId])
  @@index([familyId])
  @@index([tokenHash])
  @@map("refresh_tokens")
}

model Tenant {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique
  
  parentTenantId String? 
  parentTenant   Tenant? @relation("TenantHierarchy", fields: [parentTenantId], references: [id])
  subTenants     Tenant[] @relation("TenantHierarchy")

  email       String?
  phone       String?
  website     String?
  
  status      String   @default("PENDING") 
  type        TenantType @default(CUSTOMER)
  isSystem    Boolean  @default(false)
  
  address     Json?    

  resellerProfile ResellerProfile?
  ledgerEntries   LedgerEntry[]

  users       User[]
  branches    Branch[]
  roles       Role[]
  
  currentSubscription Subscription?
  usageLogs           UsageLog[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("tenants")
}

model Branch {
  id        String   @id @default(uuid())
  name      String
  
  address   String?
  phone     String?
  
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  users     User[]
  auditLogs AuditLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("branches")
}

// =================================================================================================
// RBAC (Roles & Permissions)
// =================================================================================================

enum RoleStatus {
  DRAFT
  PENDING_APPROVAL
  ACTIVE
  REJECTED
  ARCHIVED
}

enum RoleScope {
  SYSTEM
  TENANT
}

model Role {
  id          String   @id @default(uuid())
  name        String
  description String?
  
  // SAP-Grade Fields
  scope       RoleScope  @default(TENANT)
  level       Int        @default(10)      // Hierarchy Level (1-100)
  isLocked    Boolean    @default(false)   // Immutable system roles (e.g. SuperAdmin)
  isEnabled   Boolean    @default(true)    // Soft disable

  // Legacy field support (deprecated, mapped to scope=SYSTEM)
  isSystem    Boolean  @default(false)
  
  status      RoleStatus @default(DRAFT)
  approverId  String?
  approvalNote String?
  submittedById String?
  createdById String?

  tenantId    String?
  tenant      Tenant?  @relation(fields: [tenantId], references: [id], onDelete: Cascade)


  userRoles   UserRole[] // Active multi-role relation
  permissions RolePermission[]
  changeRequests RoleChangeRequest[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt
  version     Int      @default(1)

  @@unique([tenantId, name])
  @@map("roles")
}

model RoleChangeRequest {
  id          String   @id @default(uuid())
  scope       String   @default("TENANT")
  
  roleId      String
  role        Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  
  requestedBy String
  approvedBy  String?
  
  status      String   @default("PENDING") // PENDING, APPROVED, REJECTED
  
  diffJson    Json
  reason      String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("role_change_requests")
}

// =================================================================================================
// WORKFLOW ENGINE (SAP-Grade Generic Approval System)
// =================================================================================================

// Workflow Definition - Defines approval flow for entity types
model WorkflowDefinition {
  id          String   @id @default(uuid())
  name        String
  description String?
  
  entityType  String   // ROLE, USER, TENANT, INVOICE, etc.
  action      String   // CREATE, UPDATE, DELETE
  scope       String   @default("SYSTEM") // SYSTEM or TENANT
  
  isActive    Boolean  @default(true)
  priority    Int      @default(10) // Lower = higher priority
  
  // Risk thresholds for automatic stage escalation
  riskThreshold String? // LOW, MEDIUM, HIGH - triggers extra stages
  
  stages      WorkflowStage[]
  approvalRequests ApprovalRequest[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([entityType, action, scope])
  @@map("workflow_definitions")
}

// Workflow Stage - Sequential or Parallel approval step
model WorkflowStage {
  id              String   @id @default(uuid())
  workflowId      String
  workflow        WorkflowDefinition @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  
  name            String
  order           Int      // Execution order (1, 2, 3...)
  
  approvalType    String   @default("SEQUENTIAL") // SEQUENTIAL or PARALLEL
  requiredCount   Int      @default(1) // For PARALLEL: N of M approvers needed
  
  // Approver selection
  approverRoleIds String[] // Role IDs that can approve
  approverUserIds String[] // Specific user IDs that can approve
  
  // Timeouts
  timeoutHours    Int?     // Auto-escalate after hours
  escalateToStage Int?     // Stage order to escalate to
  
  // Security requirements
  requireMfa      Boolean  @default(false)
  requireComment  Boolean  @default(true)
  
  executions      ApprovalStageExecution[]
  
  createdAt       DateTime @default(now())
  
  @@map("workflow_stages")
}

// Approval Request - Instance of workflow execution
model ApprovalRequest {
  id              String   @id @default(uuid())
  
  workflowId      String?
  workflow        WorkflowDefinition? @relation(fields: [workflowId], references: [id])
  
  entityType      String   // ROLE, USER, etc.
  entityId        String   // ID of the entity being changed
  action          String   // CREATE, UPDATE, DELETE
  
  requestedById   String
  requestedByName String?
  
  status          String   @default("PENDING") // PENDING, IN_PROGRESS, APPROVED, REJECTED, CANCELLED
  currentStage    Int      @default(1)
  
  // Change payload
  payload         Json     // Full change diff
  riskScore       String?  // LOW, MEDIUM, HIGH, CRITICAL
  
  // Resolution
  resolvedById    String?
  resolvedByName  String?
  resolvedAt      DateTime?
  resolutionNote  String?
  
  stageExecutions ApprovalStageExecution[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([entityType, entityId])
  @@index([status])
  @@map("approval_requests")
}

// Stage Execution - Tracks each stage's approval progress
model ApprovalStageExecution {
  id              String   @id @default(uuid())
  
  requestId       String
  request         ApprovalRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
  
  stageId         String
  stage           WorkflowStage @relation(fields: [stageId], references: [id], onDelete: Cascade)
  
  stageOrder      Int
  
  status          String   @default("PENDING") // PENDING, IN_PROGRESS, APPROVED, REJECTED, SKIPPED
  
  // For PARALLEL approval tracking
  approvedCount   Int      @default(0)
  rejectedCount   Int      @default(0)
  
  // Actor info
  actorId         String?
  actorName       String?
  actorComment    String?
  actedAt         DateTime?
  
  createdAt       DateTime @default(now())
  
  @@unique([requestId, stageId])
  @@map("approval_stage_executions")
}

// Approval Decision - Individual approver vote
model ApprovalDecision {
  id                String   @id @default(uuid())
  
  approvalRequestId String
  stageIndex        Int
  
  decidedByUserId   String
  decidedByName     String?
  
  decision          String   // APPROVE, REJECT, DELEGATE, ESCALATE
  comment           String?
  
  delegatedToUserId String?
  escalatedToStage  Int?
  
  createdAt         DateTime @default(now())
  
  @@unique([approvalRequestId, stageIndex, decidedByUserId])
  @@index([approvalRequestId])
  @@map("approval_decisions")
}

// Export Job - Enterprise grade export tracking
model ExportJob {
  id                String   @id @default(uuid())
  
  scope             String   @default("SYSTEM") // SYSTEM or TENANT
  datasetKey        String   // ROLES, USERS, APPROVALS, AUDIT, TENANTS, etc.
  
  status            String   @default("QUEUED") // QUEUED, RUNNING, COMPLETED, FAILED, CANCELLED
  
  requestedByUserId String
  requestedByName   String?
  
  // Filter/Sort snapshot
  filterSnapshot    Json?    // { search, filters, sort, columns }
  
  // Output
  outputFileKey     String?  // S3 key or local path
  fileName          String?
  mimeType          String   @default("application/vnd.openxmlformats-officedocument.spreadsheetml.sheet")
  rowCount          Int?
  
  // Approval gating for high-risk exports
  requiresApproval  Boolean  @default(false)
  riskLevel         String   @default("LOW") // LOW, MEDIUM, HIGH
  approvalRequestId String?  @unique
  
  // Error handling
  errorMessage      String?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  completedAt       DateTime?
  
  @@index([requestedByUserId])
  @@index([status])
  @@map("export_jobs")
}


model UserRole {
  id        String   @id @default(uuid())
  userId    String
  roleId    String
  tenantId  String?  // Specific scope for this assignment (if null, applies to SYSTEM or User's default tenant depending on logic)
  
  assignedAt DateTime @default(now())
  assignedBy String?

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId, tenantId])
  @@map("user_roles")
}

model Permission {
  id          String   @id @default(uuid())
  name        String?   
  slug        String   @unique 
  description String?
  module      String   
  scope       String   @default("SYSTEM")

  roles       RolePermission[]
  menuItems   MenuItem[]

  @@map("permissions")
}

model PermissionSlugAlias {
  id        String   @id @default(uuid())
  oldSlug   String   @unique
  newSlug   String
  createdAt DateTime @default(now())

  @@map("permission_slug_aliases")
}

model RolePermission {
  roleId       String
  permissionId String

  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@map("role_permissions")
}

// =================================================================================================
// ACCESS CONTROL (ABAC) & AUDIT
// =================================================================================================

model AccessPolicy {
  id          String   @id @default(uuid())
  name        String
  resource    String
  action      String
  conditions  Json?
  
  userId           String?
  allowedDays      String? 
  allowedStartHour Int?
  allowedEndHour   Int?
  allowedIps       String?

  effect      String   @default("ALLOW")

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("access_policies")
}

model AuditLog {
  id        String   @id @default(uuid())
  action    String
  resource  String?
  module    String?
  
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])
  
  branchId  String?
  branch    Branch?  @relation(fields: [branchId], references: [id])

  tenantId  String?
  details   Json?
  
  ipAddress String?
  userAgent String?
  
  createdAt DateTime @default(now())

  @@map("audit_logs")
}

model SecurityLog {
  id        String   @id @default(uuid())
  action    String   
  
  userId    String?
  ipAddress String?
  userAgent String?
  device    String? // ADDED
  location  String? // ADDED
  details   Json?

  createdAt DateTime @default(now())

  @@map("security_logs")
}

// =================================================================================================
// ADDRESSES
// =================================================================================================

model Country {
  id        String   @id @default(uuid())
  name      String
  code      String   @unique
  phoneCode String

  cities    City[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  @@map("countries")
}

model City {
  id        String   @id @default(uuid())
  name      String
  countryId String
  country   Country  @relation(fields: [countryId], references: [id], onDelete: Cascade)
  districts District[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  @@map("cities")
}

model District {
  id        String   @id @default(uuid())
  name      String
  cityId    String
  city      City     @relation(fields: [cityId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  @@map("districts")
}

// =================================================================================================
// BILLING & SUBSCRIPTION
// =================================================================================================

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  SUSPENDED
  TRIALING
}

enum TenantType {
  PROVIDER
  CUSTOMER
  RESELLER
  PARTNER
}

enum LedgerAccountType {
  CASH
  REVENUE
  ACCOUNTS_RECEIVABLE
  ACCOUNTS_PAYABLE
  LIABILITY
  EXPENSE
  COMMISSION_EXPENSE
}

enum BillingCycle {
  MONTHLY
  YEARLY
}

enum InvoiceStatus {
  DRAFT
  OPEN
  PAID
  VOID
  UNCOLLECTIBLE
}

enum TransactionStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
}

model Package {
  id            String   @id @default(cuid())
  name          String
  description   String?
  priceMonthly  Decimal  @db.Decimal(10, 2)
  priceYearly   Decimal  @db.Decimal(10, 2)
  currency      String   @default("AZN")
  
  maxUsers      Int      @default(5) 
  maxStorageGB  Int      @default(10)
  maxBranches   Int      @default(1)
  
  features      String?  

  isActive      Boolean  @default(true)
  isPopular     Boolean  @default(false)

  subscriptions Subscription[]
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("packages")
}

model Subscription {
  id              String             @id @default(cuid())
  tenantId        String             @unique
  tenant          Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  packageId       String
  package         Package            @relation(fields: [packageId], references: [id])
  
  status          SubscriptionStatus @default(ACTIVE)
  billingCycle    BillingCycle       @default(MONTHLY)
  
  startDate       DateTime           @default(now())
  nextBillingDate DateTime
  endDate         DateTime?          
  trialEndsAt     DateTime?

  items           SubscriptionItem[]
  invoices        Invoice[]
  paymentMethods  PaymentMethod[]
  
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  @@map("subscriptions")
}

model SubscriptionItem {
  id             String       @id @default(cuid())
  subscriptionId String
  subscription   Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  
  name           String
  type           String       
  quantity       Int          @default(1)
  unitPrice      Decimal      @db.Decimal(10, 2)
  
  addedAt        DateTime     @default(now())

  @@map("subscription_items")
}

model Invoice {
  id             String        @id @default(cuid())
  subscriptionId String
  subscription   Subscription  @relation(fields: [subscriptionId], references: [id])
  
  number         String        @unique 
  status         InvoiceStatus @default(DRAFT)
  
  amountDue      Decimal       @db.Decimal(10, 2)
  amountPaid     Decimal       @db.Decimal(10, 2) @default(0)
  amountRemaining Decimal      @db.Decimal(10, 2)
  currency       String        @default("AZN")
  
  dueDate        DateTime
  paidAt         DateTime?
  
  pdfUrl         String?
  
  items          Json?         
  transactions   Transaction[]

  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@map("invoices")
}

model PaymentMethod {
  id             String       @id @default(cuid())
  subscriptionId String
  subscription   Subscription @relation(fields: [subscriptionId], references: [id])
  
  type           String       
  provider       String       
  token          String?      
  last4          String?
  expiryMonth    Int?
  expiryYear     Int?
  
  isDefault      Boolean      @default(false)
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@map("payment_methods")
}

model Transaction {
  id             String            @id @default(cuid())
  invoiceId      String
  invoice        Invoice           @relation(fields: [invoiceId], references: [id])
  
  amount         Decimal           @db.Decimal(10, 2)
  currency       String            @default("AZN")
  status         TransactionStatus
  
  providerTxId   String?           
  failureReason  String?
  
  processedAt    DateTime          @default(now())

  @@map("transactions")
}

model UsageLog {
  id        String   @id @default(cuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  metric    String   
  value     Float
  timestamp DateTime @default(now())
  
  @@map("usage_logs")
}

// =================================================================================================
// UTILS & MENU
// =================================================================================================

model File {
  id           String   @id @default(uuid())
  originalName String
  filename     String
  mimeType     String
  size         Int
  path         String
  bucket       String?
  
  publicUrl    String?
  uploadedBy   String? 
  user         User?   @relation(fields: [uploadedBy], references: [id]) 
  
  usage        String? // e.g. "AVATAR"
  module       String? // ADDED: e.g. "GENERAL", "INVOICE"

  createdAt    DateTime @default(now())
  @@map("files")
}

model Menu {
  id        String  @id @default(uuid())
  name      String
  slug      String? @unique
  
  items     MenuItem[]

  isActive  Boolean @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@map("menus")
}

model MenuItem {
  id          String  @id @default(uuid())
  title       String
  icon        String?
  path        String?
  order       Int     @default(0)
  
  menuId      String
  menu        Menu    @relation(fields: [menuId], references: [id], onDelete: Cascade)

  parentId    String?
  parent      MenuItem?  @relation("MenuHierarchy", fields: [parentId], references: [id])
  children    MenuItem[] @relation("MenuHierarchy")

  permissionId String?
  permission   Permission? @relation(fields: [permissionId], references: [id])

  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt

  @@map("menu_items")
}

model Notification {
  id        String   @id @default(uuid())
  subject   String
  body      String
  priority  String
  type      String
  senderId  String?
  targetFilter String? 
  createdAt DateTime @default(now())
  deliveries NotificationDelivery[]
  @@map("notifications")
}

model NotificationDelivery {
  id             String   @id @default(uuid())
  notificationId String
  userId         String
  status         String
  readAt         DateTime?
  sentAt         DateTime @default(now())
  notification   Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@map("notification_deliveries")
}

model CuratorAssignment {
  id             String   @id @default(uuid())
  userId         String
  targetTenantId String?
  targetBranchId String?
  canView        Boolean @default(true)
  canEdit        Boolean @default(false)
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@map("curator_assignments")
}

// =================================================================================================
// SYSTEM & CONFIGURATION
// =================================================================================================

model RetentionPolicy {
  id        String   @id @default(uuid())
  entity    String   // Target table/entity name
  days      Int      // Retention period in days
  action    String   // DELETE, ARCHIVE, SOFT_DELETE
  isActive  Boolean  @default(true)
  
  lastRunAt DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  
  @@map("retention_policies")
}

// =================================================================================================
// ENTERPRISE PROVIDER & ACCOUNTING
// =================================================================================================

model ResellerProfile {
  id              String   @id @default(uuid())
  tenantId        String   @unique
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  resellerCode    String   @unique @default(cuid()) // Unique code for referrals
  commissionRate  Decimal  @db.Decimal(5, 2) @default(10.00) // Percentage
  totalRevenue    Decimal  @db.Decimal(15, 2) @default(0)
  totalCommission Decimal  @db.Decimal(15, 2) @default(0)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@map("reseller_profiles")
}

model LedgerEntry {
  id            String            @id @default(uuid())
  tenantId      String            // The owner of this ledger (Provider, Reseller, or Customer)
  tenant        Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  debitAccount  LedgerAccountType
  creditAccount LedgerAccountType
  
  amount        Decimal           @db.Decimal(15, 2)
  currency      String            @default("AZN")
  
  referenceId   String?           // InvoiceID or TransactionID
  referenceType String?           // "INVOICE", "PAYOUT"
  description   String?
  
  postedAt      DateTime          @default(now())
  
  @@index([tenantId, postedAt])
  @@map("ledger_entries")
}

model BillingTransaction {
  id            String   @id @default(uuid())
  // Platform-side transaction log (separate from Invoice Transaction)
  // This tracks the raw gateway events for Platform Admin
  
  invoiceId     String?
  amount        Decimal   @db.Decimal(10, 2)
  currency      String    @default("AZN")
  status        String    // SUCCESS, FAILED
  gateway       String    // STRIPE, KAPITAL
  gatewayTxId   String?
  
  rawResponse   Json?
  
  createdAt     DateTime  @default(now())
  @@map("billing_transactions")
}
